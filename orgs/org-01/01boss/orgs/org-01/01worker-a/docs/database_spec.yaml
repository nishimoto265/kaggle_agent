# Supabase Database Specification
# Version: 0.1
# Date: 2025-06-05

database_spec:
  metadata:
    version: "0.1"
    created_date: "2025-06-05"
    database_type: "supabase_postgresql"
    realtime_enabled: true
    auto_api_generation: true
    
  platform_features:
    supabase_specific:
      - name: "realtime_subscriptions"
        description: "WebSocket-based real-time data synchronization"
        enabled_tables: ["competitions", "training_jobs", "submissions", "human_decisions"]
      
      - name: "row_level_security"
        description: "PostgreSQL RLS for fine-grained access control"
        enabled: true
        
      - name: "auto_rest_api"
        description: "Automatically generated REST API"
        base_url: "/rest/v1"
        
      - name: "auto_graphql_api"
        description: "Automatically generated GraphQL API"
        endpoint: "/graphql/v1"
        
      - name: "storage_buckets"
        description: "File storage with CDN"
        buckets: ["datasets", "models", "submissions", "logs"]
        
      - name: "edge_functions"
        description: "Serverless functions at edge locations"
        runtime: "deno"

  schema_design:
    enums:
      competition_status:
        values: ["discovered", "analyzing", "researching", "coding", "training", "submitting", "completed", "abandoned"]
        
      competition_priority:
        values: ["low", "medium", "high", "urgent"]
        
      research_status:
        values: ["pending", "processing", "completed", "failed"]
        
      approach_type:
        values: ["ensemble", "deep_learning", "traditional_ml", "feature_engineering", "preprocessing"]
        
      complexity_level:
        values: ["baseline", "intermediate", "advanced", "research"]
        
      code_status:
        values: ["pending", "generating", "completed", "failed", "validated"]
        
      training_status:
        values: ["pending", "queued", "running", "completed", "failed", "cancelled"]
        
      submission_status:
        values: ["pending", "submitted", "scored", "failed"]
        
      decision_type:
        values: ["competition_selection", "approach_approval", "budget_approval", "submission_approval", "error_handling"]
        
      decision_status:
        values: ["pending", "decided", "expired", "cancelled"]

    tables:
      competitions:
        description: "Kaggle競技情報とエージェント判断結果"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          kaggle_id:
            type: "TEXT"
            unique: true
            not_null: true
            description: "Kaggle競技ID"
          title:
            type: "TEXT"
            not_null: true
          description:
            type: "TEXT"
          category:
            type: "TEXT"
            not_null: true
          reward:
            type: "INTEGER"
          team_count:
            type: "INTEGER"
          deadline:
            type: "TIMESTAMPTZ"
            not_null: true
          evaluation_metric:
            type: "TEXT"
            not_null: true
          dataset_size:
            type: "BIGINT"
          status:
            type: "competition_status"
            default: "discovered"
          priority:
            type: "competition_priority"
            default: "medium"
          feasibility_score:
            type: "DECIMAL(3,2)"
            constraint: "CHECK (feasibility_score >= 0 AND feasibility_score <= 1)"
          estimated_cost:
            type: "DECIMAL(10,2)"
          estimated_duration:
            type: "INTERVAL"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          updated_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          deleted_at:
            type: "TIMESTAMPTZ"
            
        indexes:
          - name: "idx_competitions_status"
            columns: ["status"]
          - name: "idx_competitions_deadline"
            columns: ["deadline"]
          - name: "idx_competitions_priority"
            columns: ["priority"]
            
        rls_enabled: true
        realtime_enabled: true

      research_sessions:
        description: "Deep Research実行セッション"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          competition_id:
            type: "UUID"
            foreign_key: "competitions(id)"
            on_delete: "CASCADE"
          query_text:
            type: "TEXT"
            not_null: true
          status:
            type: "research_status"
            default: "pending"
          research_plan:
            type: "JSONB"
          findings:
            type: "JSONB"
          citations:
            type: "JSONB"
          audio_summary_url:
            type: "TEXT"
          confidence_score:
            type: "DECIMAL(3,2)"
          started_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          completed_at:
            type: "TIMESTAMPTZ"
          duration_seconds:
            type: "INTEGER"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          updated_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
            
        indexes:
          - name: "idx_research_sessions_competition_status"
            columns: ["competition_id", "status"]
          - name: "idx_research_sessions_findings_gin"
            type: "GIN"
            columns: ["findings"]
            
        rls_enabled: true

      research_approaches:
        description: "研究セッションで発見された手法"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          research_session_id:
            type: "UUID"
            foreign_key: "research_sessions(id)"
            on_delete: "CASCADE"
          title:
            type: "TEXT"
            not_null: true
          description:
            type: "TEXT"
          approach_type:
            type: "approach_type"
            not_null: true
          complexity_level:
            type: "complexity_level"
            not_null: true
          relevance_score:
            type: "DECIMAL(3,2)"
          innovation_score:
            type: "DECIMAL(3,2)"
          feasibility_score:
            type: "DECIMAL(3,2)"
          final_rank:
            type: "INTEGER"
          required_frameworks:
            type: "TEXT[]"
          estimated_training_time:
            type: "INTERVAL"
          estimated_cost:
            type: "DECIMAL(10,2)"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"

      code_generations:
        description: "Claude APIによるコード生成記録"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          competition_id:
            type: "UUID"
            foreign_key: "competitions(id)"
            on_delete: "CASCADE"
          approach_id:
            type: "UUID"
            foreign_key: "research_approaches(id)"
            on_delete: "SET NULL"
          task_description:
            type: "TEXT"
            not_null: true
          requirements:
            type: "JSONB"
          constraints:
            type: "JSONB"
          target_framework:
            type: "TEXT"
            not_null: true
          status:
            type: "code_status"
            default: "pending"
          generated_code:
            type: "JSONB"
            description: "main_script, training_script, inference_script等"
          dockerfile:
            type: "TEXT"
          requirements_txt:
            type: "TEXT"
          documentation:
            type: "TEXT"
          claude_model:
            type: "TEXT"
          total_tokens:
            type: "INTEGER"
          cost_usd:
            type: "DECIMAL(10,4)"
          started_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          completed_at:
            type: "TIMESTAMPTZ"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          updated_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
            
        indexes:
          - name: "idx_code_generations_requirements_gin"
            type: "GIN"
            columns: ["requirements"]
            
        rls_enabled: true

      training_jobs:
        description: "SaladCloud GPU学習ジョブ"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          competition_id:
            type: "UUID"
            foreign_key: "competitions(id)"
            on_delete: "CASCADE"
          code_generation_id:
            type: "UUID"
            foreign_key: "code_generations(id)"
            on_delete: "CASCADE"
          gpu_type:
            type: "TEXT"
            not_null: true
          container_config:
            type: "JSONB"
          environment_vars:
            type: "JSONB"
          status:
            type: "training_status"
            default: "pending"
          salad_container_group_id:
            type: "TEXT"
          salad_job_id:
            type: "TEXT"
          started_at:
            type: "TIMESTAMPTZ"
          completed_at:
            type: "TIMESTAMPTZ"
          duration_seconds:
            type: "INTEGER"
          gpu_hours:
            type: "DECIMAL(10,4)"
          cost_usd:
            type: "DECIMAL(10,4)"
          model_metrics:
            type: "JSONB"
          logs:
            type: "TEXT"
          error_message:
            type: "TEXT"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          updated_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
            
        indexes:
          - name: "idx_training_jobs_status_created"
            columns: ["status", "created_at"]
            
        rls_enabled: true
        realtime_enabled: true

      submissions:
        description: "Kaggle提出記録"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          competition_id:
            type: "UUID"
            foreign_key: "competitions(id)"
            on_delete: "CASCADE"
          training_job_id:
            type: "UUID"
            foreign_key: "training_jobs(id)"
            on_delete: "SET NULL"
          kaggle_submission_id:
            type: "TEXT"
          submission_message:
            type: "TEXT"
          public_score:
            type: "DECIMAL(10,6)"
          private_score:
            type: "DECIMAL(10,6)"
          leaderboard_rank:
            type: "INTEGER"
          status:
            type: "submission_status"
            default: "pending"
          submission_file_path:
            type: "TEXT"
            description: "Supabase Storage path"
          file_size_bytes:
            type: "BIGINT"
          submitted_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          scored_at:
            type: "TIMESTAMPTZ"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
            
        indexes:
          - name: "idx_submissions_competition_score"
            columns: ["competition_id", "public_score DESC NULLS LAST"]
            
        rls_enabled: true
        realtime_enabled: true

      human_decisions:
        description: "人間による意思決定が必要な事項"
        columns:
          id:
            type: "UUID"
            primary_key: true
            default: "gen_random_uuid()"
          competition_id:
            type: "UUID"
            foreign_key: "competitions(id)"
            on_delete: "CASCADE"
          decision_type:
            type: "decision_type"
            not_null: true
          context:
            type: "JSONB"
            not_null: true
          options:
            type: "JSONB"
            not_null: true
          status:
            type: "decision_status"
            default: "pending"
          selected_option:
            type: "TEXT"
          human_feedback:
            type: "TEXT"
          notification_sent_at:
            type: "TIMESTAMPTZ"
          notification_channels:
            type: "TEXT[]"
            description: "slack, discord, email等"
          expires_at:
            type: "TIMESTAMPTZ"
          created_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
          decided_at:
            type: "TIMESTAMPTZ"
          updated_at:
            type: "TIMESTAMPTZ"
            default: "NOW()"
            
        indexes:
          - name: "idx_human_decisions_status_expires"
            columns: ["status", "expires_at"]
            
        rls_enabled: true
        realtime_enabled: true

  storage_configuration:
    buckets:
      datasets:
        public: false
        description: "Kaggle dataset files"
        max_file_size: "10GB"
        allowed_mime_types: ["application/zip", "text/csv", "application/json"]
        
      models:
        public: false
        description: "Trained model artifacts"
        max_file_size: "5GB"
        allowed_mime_types: ["application/octet-stream", "application/x-pytorch", "application/x-tensorflow"]
        
      submissions:
        public: false
        description: "Kaggle submission files"
        max_file_size: "100MB"
        allowed_mime_types: ["text/csv", "application/json"]
        
      logs:
        public: false
        description: "Training and execution logs"
        max_file_size: "500MB"
        allowed_mime_types: ["text/plain", "application/json"]

  functions:
    database_functions:
      update_updated_at_column:
        description: "Automatically update updated_at timestamp"
        language: "plpgsql"
        trigger_tables: ["competitions", "research_sessions", "code_generations", "training_jobs", "human_decisions"]
        
      calculate_training_cost:
        description: "Calculate GPU training cost based on hours and type"
        parameters:
          - name: "gpu_hours"
            type: "DECIMAL"
          - name: "gpu_type"
            type: "TEXT"
        returns: "DECIMAL"
        language: "plpgsql"

  realtime_configuration:
    enabled_tables:
      - table: "competitions"
        events: ["INSERT", "UPDATE", "DELETE"]
        filter: "status IN ('training', 'submitting')"
        
      - table: "training_jobs"
        events: ["INSERT", "UPDATE"]
        filter: "status IN ('running', 'completed', 'failed')"
        
      - table: "submissions"
        events: ["INSERT", "UPDATE"]
        
      - table: "human_decisions"
        events: ["INSERT", "UPDATE"]
        filter: "status = 'pending'"

  migration_strategy:
    versioning:
      format: "YYYYMMDDHHMMSS_description.sql"
      directory: "supabase/migrations"
      
    deployment:
      environments: ["development", "staging", "production"]
      rollback_strategy: "automatic_on_failure"
      
    schema_evolution:
      breaking_changes: "require_manual_approval"
      backwards_compatibility: "maintain_for_2_versions"

  monitoring:
    performance_metrics:
      - "query_execution_time"
      - "index_usage"
      - "table_size_growth"
      - "realtime_connection_count"
      
    alerts:
      - condition: "query_time > 5s"
        action: "log_slow_query"
      - condition: "storage_usage > 80%"
        action: "notify_admin"
      - condition: "failed_realtime_connections > 10"
        action: "investigate_connectivity"

  security:
    row_level_security:
      enabled: true
      default_policy: "authenticated_users_read_only"
      
    api_security:
      rate_limiting: "100_requests_per_minute"
      cors_origins: ["https://kaggle-agent.app", "http://localhost:3000"]
      
    data_encryption:
      at_rest: true
      in_transit: true
      key_management: "supabase_managed" 