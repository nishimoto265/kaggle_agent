# Kaggle エージェント要件定義

*バージョン 1.0 — 2025-06-05*

---

## 1 目的

自律的な「Kaggle エージェント」を設計・実装し、Kaggle コンペティションへの参加をエンドツーエンドで実現する：データ取得とリサーチからクラウド上でのモデル開発、提出までを自動化しつつ、重要なタイミングで人間のオペレーターを介在させる。

## 2 範囲

* **対応コンペティション**: Tabular、NLP、CV、時系列タスク（外部コード実行および API 経由の提出を許可）
* **計算予算**: GPU コスト平均 1 時間あたり ≤ \$0.15（SaladCloud の消費者向け GPU を活用）
* **イテレーションサイクル**: コンペ選定から初回リーダーボード提出まで24時間以内を目標

## 3 高レベルワークフロー

> **🏗️ システムアーキテクチャ**: 詳細なワークフロー・データフロー設計は [`architecture_design.md`](architecture_design.md) を参照  
> **📋 開発プロセス**: 実装フローは [`worker_instructions.md`](worker_instructions.md) と [`boss_instructions.md`](boss_instructions.md) を参照

1. **コンペティション選択**（現状は手動）
2. **データ取得**: Kaggle API 経由でメタデータとデータセットを取得
3. **リサーチ＆アイデア創出**: Google Deep Research API を用いて複数回問い合わせ、手法案を収集
4. **要件合成**: 収集した手法案それぞれに対し、構造化された要件仕様を生成
5. **並列実装**: マルチエージェントによる同時並列実装
6. **環境プロビジョニング**: SaladCloud 上で GPU インスタンス構築
7. **コード生成＆学習実行**: Claude Code を利用した実装・学習実行
8. **品質評価＆統合**: 最適実装の自動選択
9. **ヒューマンチェックポイント**: 人間判断が必要な場面での選択肢提示
10. **提出**: Kaggle API を利用した `submission.csv` 提出・スコア取得
11. **評価＆フィードバック**: リーダーボード結果解析
12. **イテレーションループ**: 結果に基づく次プラン生成

## 4 機能要件

### 4.1 コンペティション発見＆データ取得

* ユーザーの Kaggle API トークンを用いて認証を行う
* コンペティションのメタデータ（締め切り、ルール、評価指標など）を取得
* データセットをオブジェクトストレージにミラーリングし、重複ダウンロードを防止するためのチェックサムを管理

### 4.2 リサーチ＆アイデア創出

* コンペティションの目的に応じて Google Deep Research API を `answerGenerationMode="research"` で呼び出す
* 少なくとも 10 件の異なる手法案を収集し、各案を要約・ランキング
* データ規模や計算資源、技術的難易度などを考慮し、実現可能性の高い順にソート

### 4.3 要件合成

* 各手法案を以下の要素を持つ YAML 形式の仕様書に変換する:

  * **モデルファミリ**（例: LightGBM、EfficientNet-V2、Transformer）
  * **前処理パイプライン**
  * **必要最低限のハードウェア要件**（GPU VRAM、CPU RAM）
  * **想定学習時間**

### 4.4 環境プロビジョニング＆管理

* **クラウドプロバイダー**: SaladCloud 分散型 GPU
* **API/CLI**: `saladctl` またはベータ版 REST API を使用し、オンデマンドでノードを起動
* 要件に見合った最安値の GPU を自動選定し、Docker イメージを事前プル
* データセットや成果物を格納するためにオブジェクトストレージ（MinIO/S3 互換）をマウント

### 4.5 コード生成＆学習実行

* YAML 仕様書とコードベースの骨子を **Claude Code** に渡し、MCP モードで実装を生成
* GitHub Actions を利用してユニットテスト・Lint を実行し、リポジトリにコミット
* コンテナ内で学習スクリプトを実行し、Weigths & Biases にログを送信

### 4.6 ヒューマンインザループ判断

* 判断が必要なタイミング:

  * モデルがベースラインを下回った場合
  * ハイパーパラメータ選択が曖昧な場合
  * コストが見積もりを超過しそうな場合
* インターフェース: Slack または Discord ボット経由で最大3つの選択肢を提示し、絵文字リアクションやスラッシュコマンドで応答を待つ

### 4.7 提出＆評価

* 予測結果を `submission.csv` としてパッケージ化
* Kaggle API 経由で提出し、公開リーダーボードのスコアと順位を取得

### 4.8 継続的改善

* 各提出後は以下をまとめる:

  * **スコア変動**：前回ベストとの比較
  * **エラー分析**：（実データが入手可能な場合）
  * **リソース使用量**：GPU 時間、費用
* まとめた内容を Deep Research API + Claude Code に渡し、次のイテレーション計画を生成

### 4.9 UI・インターフェース要件

#### 4.9.1 Webコントロールパネル要件

**メイン画面構成**
* ヘッダー: プロジェクト名、現在時刻、アラート通知数、ユーザー情報
* サイドバー: ナビゲーションメニュー（ダッシュボード、エージェント、ログ、設定）
* メインエリア: 10エージェント並列実行状況の一覧表示
* フッター: システム状態、バージョン情報、ヘルプリンク

**10エージェント一覧表示**
* テーブル形式で10行のエージェント情報を表示
* 各行に以下の情報を含む:
  - エージェントID（Agent-01 ～ Agent-10）
  - アプローチ手法名（LightGBM、XGBoost、Neural等）
  - 進行状況（プログレスバー + パーセンテージ）
  - 現在の最高スコア（数値 + トレンド矢印）
  - 状態アイコン（実行中🔄、完了✅、失敗❌、待機⏸️）
  - 経過時間（HH:MM:SS形式）
  - 使用リソース（GPU使用率、メモリ使用量）
  - アクションボタン（詳細、停止、再開、ログ）

**具体的表示例**
```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│ Kaggle Agent Control Center - Store Sales Forecasting Competition                      │
├────────────────────────────────────────────────────────────────────────────────────────┤
│ 📊 Agent Status Overview (7/10 Active) | 🕒 Elapsed: 02:34:12 | 💰 Cost: $12.47/$50.00 │
├──────┬──────────────┬─────────┬────────┬─────────┬──────────┬──────────────┬─────────────┤
│Agent │Approach      │Progress │Score   │Status   │Time      │Resources     │Actions      │
├──────┼──────────────┼─────────┼────────┼─────────┼──────────┼──────────────┼─────────────┤
│01    │LightGBM+FE   │██████▒▒│0.9245↗│🔄Running│02:34:12  │GPU:85% M:12GB│🔍📊⏹️📋    │
│02    │XGBoost+Optuna│████▒▒▒▒│0.9198↗│🔄Running│02:15:33  │GPU:78% M:10GB│🔍📊⏹️📋    │
│03    │CatBoost+Auto │███▒▒▒▒▒│0.9156  │🔄Running│01:45:22  │GPU:65% M:8GB │🔍📊⏹️📋    │
│04    │RandomForest  │██████▒▒│0.9089↘│🔄Running│02:12:45  │GPU:45% M:6GB │🔍📊⏹️📋    │
│05    │TabNet+Deep   │████▒▒▒▒│0.9067  │🔄Running│01:58:15  │GPU:92% M:14GB│🔍📊⏹️📋    │
│06    │NODE+GB       │█████▒▒▒│0.8945  │🔄Running│01:33:28  │GPU:68% M:9GB │🔍📊⏹️📋    │
│07    │MLP+FeatureS  │██▒▒▒▒▒▒│0.8756↘│🔄Running│01:12:37  │GPU:55% M:7GB │🔍📊⏹️📋    │
│08    │Meta-Learning │▒▒▒▒▒▒▒▒│--     │❌Failed │00:23:15  │GPU:0%  M:0GB │🔍🔄📋❌    │
│09    │Multi-Modal   │█▒▒▒▒▒▒▒│--     │⏸️Queued │--        │GPU:0%  M:0GB │🔍▶️📋⏳    │
│10    │Custom-Algo   │███████▒│0.9312↗│✅Complete│01:45:33  │GPU:0%  M:0GB │🔍📊📋✅    │
└──────┴──────────────┴─────────┴────────┴─────────┴──────────┴──────────────┴─────────────┘

🚨 Alert: Agent-08 crashed (OutOfMemoryError) - Auto restart in 5 minutes
🎯 Best Score: 0.9312 (Agent-10) | 📈 Trending: +0.0234 vs baseline
⚡ Recommendation: Scale up Agent-01 resources for potential score improvement
```

**詳細表示モーダル例（Agent-01クリック時）**
```
┌────────────────────────────────────────────────────────────────────────────┐
│ 🔍 Agent-01 Detailed View - LightGBM + Feature Engineering                 │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│ 📋 Basic Info:                                                            │
│   • Approach: LightGBM + Advanced Feature Engineering                     │
│   • Parameters: n_estimators=5000, learning_rate=0.01, max_depth=7        │
│   • Status: Running (Fold 4/5) | Progress: 78% ████████▒▒                │
│   • Score: 0.9245 (↗+0.0034 from last checkpoint)                        │
│                                                                            │
│ 📊 Performance Graph:                                                     │
│   Score Trend:  0.91 ──→ 0.915 ──→ 0.921 ──→ 0.924 ──→ 0.9245           │
│   GPU Usage:    [▓▓▓▓▓▓▓▓▒▒] 85% | Memory: [▓▓▓▓▓▓▒▒▒▒] 12GB/16GB      │
│                                                                            │
│ 📈 Intermediate Results:                                                  │
│   • CV Score: 0.9234 ± 0.0012                                            │
│   • Top Features: store_sales_lag_7, day_of_week, seasonal_trend          │
│   • Feature Count: 847 (original: 64)                                     │
│                                                                            │
│ 📝 Recent Logs:                                                          │
│   [14:23:45] Training fold 4/5... ETA: 15 minutes                        │
│   [14:20:12] Fold 3 completed - Score: 0.9241                            │
│   [14:15:33] Feature engineering phase completed                          │
│   [14:12:07] Starting hyperparameter optimization                         │
│                                                                            │
│ 💬 Direct Communication:                                                 │
│   ┌─ Send Message to Agent ────────────────────────────────────────────┐ │
│   │ > Try alternative feature selection approach                       │ │
│   │ [Send] [Suggest] [Emergency Stop]                                  │ │
│   └─────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│ 🖥️ Remote Access:                                                        │
│   [🖱️ Open Cursor IDE] [⌨️ Terminal Access] [📁 File Browser] [🔗 VNC]    │
│                                                                            │
│ 🛠️ Actions: [⏹️ Stop] [⏸️ Pause] [⚙️ Adjust] [📋 Full Log] [💾 Save]     │
└────────────────────────────────────────────────────────────────────────────┘
```

**リアルタイム更新**
* WebSocket接続による1秒間隔の自動更新
* 状態変化時の視覚的フィードバック（色変更、アニメーション）
* 重要な変化（完了、エラー、高スコア）の通知ポップアップ

#### 4.9.2 人間介入インターフェース要件

**Web介入画面**
* 介入要求時に専用画面へ自動遷移
* 問題状況の詳細説明（何が起きているか、なぜ介入が必要か）
* 現在の状況サマリー（実行中エージェント数、最高スコア、残り時間）
* 3つの選択肢を大きなカードとして表示
* 各選択肢に推奨度、リスク、コスト、実行時間を明記
* 30秒カウントダウンタイマー表示
* コメント入力欄（判断理由記録用）

**Slack/Discord通知**
* 介入要求の即座通知
* 状況要約（絵文字アイコン付き）
* 3つの選択肢を番号付きボタンで表示
* 詳細確認用のWebリンク
* 緊急度に応じた通知頻度制御

#### 4.9.3 自動メンテナンス表示要件

**GitHub Actions ステータス**
* メンテナンス実行状況をリアルタイム表示
* テスト結果サマリー（成功/失敗件数、カバレッジ）
* 自動生成Issue一覧（重要度別ソート）
* 修正推奨事項の表示
* メンテナンス履歴（過去30日分）

**自動Issue表示**
* Issue一覧テーブル（タイトル、作成日時、優先度、担当者）
* 各Issueクリックで詳細モーダル表示
* Issue内容（問題詳細、推奨対応、関連ファイル）
* 自動修正提案（可能な場合）
* 手動対応の手順説明

#### 4.9.4 モバイル対応要件

**レスポンシブデザイン**
* スマートフォン・タブレット対応
* 画面サイズに応じたレイアウト調整
* タッチ操作への最適化
* モバイル専用の簡易表示モード

**プッシュ通知**
* 重要なイベントのプッシュ通知
* 介入要求の緊急通知
* エージェント完了・失敗通知
* 通知設定のカスタマイズ機能

#### 4.9.5 データ可視化要件

**ダッシュボードチャート**
* 10エージェントのスコア推移グラフ（時系列）
* リソース使用量の円グラフ（GPU、メモリ、コスト）
* 成功率・失敗率の積み上げ棒グラフ
* エージェント別実行時間の比較グラフ

**詳細分析画面**
* 各エージェントの詳細パフォーマンス分析
* 手法別成功率の統計
* コスト効率の分析（スコア向上 vs コスト）
* 過去のコンペティション結果との比較

#### 4.9.6 ユーザビリティ要件

**操作性**
* 直感的なアイコン・色分け（成功=緑、失敗=赤、実行中=青）
* キーボードショートカット対応
* ドラッグ&ドロップでの操作
* 右クリックコンテキストメニュー

**アクセシビリティ**
* WCAG 2.1 AA準拠
* スクリーンリーダー対応
* キーボードナビゲーション
* 色覚障害者への配慮（形状・パターンでの識別）

**学習・ヘルプ**
* 初回利用時のガイドツアー
* 各機能のヘルプポップアップ
* FAQ・ドキュメントリンク
* エラー時の解決ヒント表示

#### 4.9.7 パフォーマンス要件

**応答性**
* 画面読み込み時間: 3秒以内
* 操作レスポンス: 1秒以内
* リアルタイム更新遅延: 2秒以内
* 大量データ表示: 100エージェント同時表示対応

**安定性**
* 24時間連続稼働対応
* 接続断時の自動復旧
* データ整合性の保証
* セッション管理（30分無操作でタイムアウト）

#### 4.9.8 エージェント直接操作機能要件

**直接メッセージ通信**
* エージェントへのリアルタイムメッセージ送信機能
* メッセージタイプ別の送信オプション:
  - **指示メッセージ**: 具体的な作業指示（特徴量追加、手法変更等）
  - **質問メッセージ**: エージェントからの回答を求める質問
  - **緊急メッセージ**: 即座停止・方向転換指示
  - **提案メッセージ**: 改善案・代替案の提示
* エージェントからの応答表示（承認・質問・エラー報告）
* メッセージ履歴の保存・検索機能

**リモートCursor/IDE アクセス**
* Web経由でのCursor IDE リモート接続
* エージェントが編集中のファイルへのリアルタイムアクセス
* ペアプログラミングモード（人間とエージェントの協調編集）
* IDE機能のWeb UI統合:
  - コード補完・構文ハイライト
  - ファイルエクスプローラー
  - Git操作パネル
  - デバッグ機能

**ターミナルアクセス機能**
* Web内ターミナルエミュレーター
* エージェントが実行中のターミナルセッションへの接続
* 複数ターミナルタブの管理
* ターミナル操作権限の制御（読み取り専用/読み書き）
* コマンド履歴の共有・記録

**ファイルシステムアクセス**
* Web経由でのファイルブラウザー
* エージェントワークスペースのファイル一覧・編集
* ファイルアップロード・ダウンロード機能
* リアルタイムファイル変更通知
* バージョン管理（Git統合）

**画面共有・VNC機能**
* エージェントのデスクトップ画面への接続
* Jupyter Notebook・可視化ツールの共有表示
* 画面操作権限の制御
* 画面録画・スクリーンショット機能
* 低遅延ストリーミング（<500ms）

**双方向コミュニケーション**
* エージェントからの質問・確認要求の表示
* 選択肢形式での迅速な回答機能
* エージェントの状況報告の自動受信
* 緊急事態時の自動通知（エラー、リソース不足等）

**セキュリティ・権限管理**
* ユーザー認証・セッション管理
* エージェント別アクセス権限の設定
* 操作ログの記録・監査
* 機密ファイルへのアクセス制限
* セキュアな通信（WSS/HTTPS）

**技術実装要件**
* WebRTC による低遅延通信
* WebSocket によるリアルタイム双方向通信
* Docker/Kubernetes のエージェントコンテナへの接続
* SSH/VNC プロトコルのWeb統合
* 負荷分散・スケーラビリティ対応

**使用例シナリオ**
```
1. エージェント監視中にスコア改善の兆候を発見
   ↓
2. 詳細画面からエージェントにメッセージ送信
   「現在のアプローチを続行して、追加で時系列特徴量を検討してください」
   ↓
3. エージェントから質問が返信される
   「lag_7とlag_14のどちらを優先しますか？」
   ↓
4. 選択肢ボタンで迅速回答
   ↓
5. 必要に応じてCursor IDEを開いてコードレビュー
   ↓
6. ターミナルで直接デバッグ作業を支援
```

**パフォーマンス要件**
* メッセージ送受信遅延: 100ms以内
* IDE画面表示遅延: 500ms以内
* ターミナル操作遅延: 200ms以内
* 同時接続数: 10エージェント×5オペレーター対応
* セッション持続時間: 24時間まで

### 4.10 並列実行管理要件

#### 4.10.1 10エージェント並列実行

**エージェント分散戦略**
* 基本手法群（Agent 01-04）: LightGBM、XGBoost、CatBoost、Random Forest
* 深層学習群（Agent 05-07）: TabNet、NODE、MLP
* 高度手法群（Agent 08-10）: Meta-Learning、Multi-Modal、Custom Algorithm
* 各エージェントの独立したワークスペース確保
* 共有リソースの競合回避機能

**動的リソース割り当て**
* GPU・メモリの動的割り当て調整
* 成功率の高いエージェントへのリソース集中
* 失敗エージェントの早期停止判断
* コスト上限に基づくリソース制御

#### 4.10.2 品質評価・統合システム
1. **コンペティション選択**（現状は手動）
2. **データ取得**: Kaggle API 経由でメタデータとデータセットを取得
3. **リサーチ＆アイデア創出**: Google Deep Research API を用いて複数回問い合わせ、10 種類程度の手法案を収集
4. **要件合成**: 収集した手法案それぞれに対し、構造化された要件仕様を生成
5. **並列実装**: 10エージェントによる同時並列実装
6. **環境プロビジョニング**: SaladCloud 上で GPU インスタンスを立ち上げ、必要な環境を構築
7. **コード生成＆学習実行**: Claude Code を利用して実装し、学習を実行
8. **品質評価＆統合**: 最適実装の自動選択
9. **ヒューマンチェックポイント**: 不確実性が一定以上の場面で、複数の選択肢を提示して人間に判断を仰ぐ
10. **提出**: Kaggle API を利用して `submission.csv` を提出し、スコアを取得
11. **評価＆フィードバック**: リーダーボード結果を解析し、スコア変化やエラー分析を行う
12. **イテレーションループ**: 結果をもとに要約を作成し、Deep Research API + Claude Code で次のプランを生成

### 3.1 並列実行ワークフロー

```
┌─────────────────┐
│ 1. コンペ選択    │ (手動)
└─────┬───────────┘
      │
┌─────▼───────────┐
│ 2. データ取得    │ 
└─────┬───────────┘
      │
┌─────▼───────────┐    ┌──────────────────┐
│ 3. リサーチ     │───►│ 10案並列生成      │
│    &アイデア創出 │    │ (Deep Research)  │
└─────┬───────────┘    └─────┬────────────┘
      │                      │
┌─────▼───────────┐         │
│ 4. 要件仕様生成  │◄────────┘
└─────┬───────────┘
      │
┌─────▼───────────┐    ┌──────────────────┐
│ 5. 並列実装     │───►│ 10エージェント    │
│    (マルチAgent) │    │ 並列実行         │
└─────┬───────────┘    └─────┬────────────┘
      │                      │
┌─────▼───────────┐         │
│ 6. 品質評価     │◄────────┘
│    &最適選択    │
└─────┬───────────┘
      │
┌─────▼───────────┐
│ 7. 提出&評価    │
└─────┬───────────┘
      │
┌─────▼───────────┐    ┌──────────────────┐
│ 8. 成果分析     │───►│ 失敗時:          │
│    &学習       │    │ 人への報告       │
└─────────────────┘    │ 代替案提示       │
                      └──────────────────┘
```


**自動品質評価**
* コード品質: 複雑度、保守性、可読性、標準準拠（25%）
* テストカバレッジ: 行・分岐・関数カバレッジ（25%）
* パフォーマンス: 実行時間、メモリ使用量、スケーラビリティ（25%）
* 保守性: モジュール性、文書化、エラーハンドリング（15%）
* ドキュメント: 完全性、明確性、例示（10%）

**統合判定基準**
* 総合スコア70点以上で統合候補
* テストカバレッジ90%以上必須
* パフォーマンス要件達成必須
* セキュリティ要件遵守必須
* 人間の最終承認（オプション）

#### 4.10.3 自動メンテナンス・Issue管理

**GitHub Actions ワークフロー**
* 6時間毎の定期実行
* プッシュ時の自動実行
* 手動実行機能
* 並列テスト実行（10分以内完了）

**自動Issue生成**
* テスト失敗時の詳細Issue作成
* カバレッジ低下の警告Issue
* パフォーマンス劣化の分析Issue
* セキュリティ脆弱性の報告Issue
* 責任者への自動アサイン

**Issue管理機能**
* 優先度別の自動分類
* 関連Issue間の自動リンク
* 修正提案の自動生成
* 進捗追跡・期限管理

#### 4.10.4 人間介入・代替案システム

**介入トリガー条件**
* 3つ以上のエージェントが失敗
* 全エージェントのスコアが閾値下回り
* 予算の80%超過
* 締切24時間前で目標未達成
* 未知のエラーパターン検出

**代替案生成・実行**
* 失敗パターン分析による自動代替案生成
* 成功確率による代替案ランキング
* リスク・コスト・時間の事前評価
* 人間承認後の自動実行
* 代替案実行の進捗監視

## 5 非機能要件

| カテゴリ        | 要件                                        |
| ----------- | ----------------------------------------- |
| **パフォーマンス** | 初回提出 ≤24時間、以降のイテレーション ≤8時間                |
| **コスト**     | GPU コスト平均 ≤ \$0.15/時間、ストレージ ≤ \$0.01/GB-月 |
| **信頼性**     | 失敗したジョブは自動再起動、リトライポリシー ×3                 |
| **セキュリティ**  | トークンは HashiCorp Vault に保存、ネットワーク送信は最小化    |
| **再現性**     | Docker イメージのダイジェストおよびパッケージバージョンを固定        |
| **拡張性**     | プラグイン機構を備え、新規クラウドプロバイダーや LLM を追加可能        |

## 6 外部インターフェース

| サービス                         | 用途                           |
| ---------------------------- | ---------------------------- |
| **Kaggle API**               | コンペティションメタデータ取得、データダウンロード、提出 |
| **Google Deep Research API** | 文献・解法検索の自動化                  |
| **Anthropic Claude Code**    | コード生成およびリファクタリング             |
| **SaladCloud API**           | GPU プロビジョニング、ジョブ実行           |
| **通知（Slack/Discord）**        | ヒューマンインザループの判断提示             |

## 7 システムアーキテクチャ

```
┌──────────┐    プロンプト    ┌──────────────┐
│ オペレーター │◄─────────────│ 決定ボット   │
└──────────┘               └─────┬────────┘
                                   │選択肢
    GitOps プッシュ               ▼
┌────────────┐ 構成要件 ┌───────────────────┐ コード ┌────────────┐
│ プランナー & │────────►│ Claude Code エージェント │───────►│ リポジトリ + CI │
│ リサーチャー │          └───────────────────┘         └────────────┘
     │データ                        ▲実行
     ▼                             │イメージ
┌────────────┐ 提出  ┌───────────────────┐ ログ  ┌────────┐
│ データ &    │──────►│ SaladCloud ランナー │──────►│ W&B UI │
│ 成果物      │       └───────────────────┘         └────────┘
```

## 8 技術スタック

* **言語**: Python 3.12（Poetry）、運用スクリプトは Bash
* **コンテナ**: Docker（CUDA 12 ベース）、ローカル開発は docker-compose
* **オーケストレーション**: Prefect 3 / LangGraph によるジョブ DAG
* **CI/CD**: GitHub Actions — ユニットテスト、Lint、イメージビルド
* **モニタリング**: Weights & Biases ＋ Prometheus
* **リアルタイム通信**: WebSocket、WebRTC、Redis Pub/Sub
* **リモートアクセス**: SSH、VNC、xterm.js、code-server
* **メッセージキュー**: Redis/RabbitMQ
* **認証・セッション**: JWT、Redis Session Store
* **ファイル同期**: Git、rsync、inotify

## 9 クラウド GPU ベースライン

| GPU      | VRAM  | Salad 価格\* | ユースケース                |
| -------- | ----- | ---------- | --------------------- |
| GTX 1650 | 4 GB  | \$0.02/時間  | スモークテスト、Tabular データ解析 |
| RTX 3060 | 12 GB | \$0.08/時間  | 中規模 CV/NLP            |
| RTX 4090 | 24 GB | \$0.32/時間  | 大規模トレーニング             |

\*2025-06-05 に取得した SaladCloud 公開価格一覧より

## 10 リスク＆対策

| リスク                  | 発生確率 | 影響度 | 対策                  |
| -------------------- | ---- | --- | ------------------- |
| API レート制限            | 中    | 中   | 指数バックオフを実装          |
| 消費者向け GPU の仕様不安定     | 高    | 中   | VRAM を起動前に必ずチェック    |
| Kaggle データのダウンロードが失敗 | 低    | 高   | データを S3 にミラーし、同期を行う |
| コスト超過                | 中    | 高   | 予算ガードレールとアラートを設定    |

## 11 マルチエージェント開発システム要件

### 11.1 概要
Claude Codeエージェントを活用したマルチエージェント開発環境により、並列開発と競争的品質向上を実現する。

### 11.2 組織構造要件
- **4つの専門組織**: Core Infrastructure、Application Modules、Interfaces、Quality Assurance
- **Boss-Workerパターン**: 各組織に1名のBoss（評価者）と3名のWorker（実装者）
- **git worktree活用**: 組織ごとの独立ワークスペース
- **競争的実装**: 同一モジュールを3つのアプローチで並列実装

### 11.3 エージェント役割要件

#### 11.3.1 Boss Agent
- Worker実装の品質評価
- 最適実装の選択判断
- メインブランチへの統合管理
- 品質基準の維持

#### 11.3.2 Worker Agent
- **Worker 1,2,3**: AI出力変動を活用した並列実装（同一プロンプトから異なる実装生成）
- **Worker B**: 保守性・可読性重視の実装
- **Worker C**: 拡張性・モジュール性重視の実装

### 11.4 プロンプト管理システム要件

#### 11.4.1 プロンプトテンプレート管理
- **役割別プロンプト**: Boss/Worker A/B/C用の専用プロンプトテンプレート
- **階層構造**: base_prompt（基本役割）→ 専門プロンプト（evaluation/implementation/TDD）
- **コンテキスト変数**: 動的情報注入用のパラメータ定義
- **バージョン管理**: プロンプトの履歴管理とロールバック機能

#### 11.4.2 動的プロンプト生成
- **テンプレート処理**: Jinja2ベースの動的プロンプト構築
- **コンテキスト注入**: タスク情報、進捗状況、評価基準の自動挿入
- **@参照システム**: ファイルパス参照による情報共有
- **リアルタイム更新**: タスク状況変化に応じたプロンプト自動更新

#### 11.4.3 CLAUDE.md生成システム
- **自動生成**: プロンプトテンプレートからCLAUDE.mdを自動構築
- **エージェント配布**: 各worktreeワークスペースへの自動配置
- **更新通知**: プロンプト変更時のエージェント再起動トリガー
- **整合性チェック**: プロンプトバージョンとタスク状態の一致検証

### 11.5 開発フロー要件

#### 11.5.1 TDD開発プロセス
1. 要件分析・理解
2. テストケース設計
3. テストコード実装
4. TDD実装サイクル（Red-Green-Refactor）
5. ドキュメント作成

#### 11.5.2 評価・統合プロセス
1. Worker実装完了の検知
2. Boss評価のトリガー
3. 多軸評価（品質・テスト・パフォーマンス・保守性・文書化）
4. 最適実装の選択
5. メインブランチへの統合

### 11.6 品質管理要件

#### 11.6.1 評価基準
- **コード品質**: 25% - 複雑度、保守性、可読性、標準準拠
- **テストカバレッジ**: 25% - 行・分岐・関数カバレッジ
- **パフォーマンス**: 25% - 実行時間、メモリ使用量、スケーラビリティ
- **保守性**: 15% - モジュール性、文書化、エラーハンドリング
- **ドキュメント**: 10% - 完全性、明確性、例示

#### 11.6.2 品質ゲート
- 総合スコア70点以上で統合可能
- テストカバレッジ90%以上必須
- パフォーマンス要件達成必須
- セキュリティ要件遵守必須

### 11.7 ワークスペース管理要件
- Git worktree による物理的分離
- 組織別ブランチ戦略
- 自動ワークスペース生成
- 成果物の一元管理

### 11.8 進捗監視要件
- リアルタイム進捗追跡
- フェーズ別進捗可視化
- 自動完了検知
- パフォーマンスメトリクス収集

### 11.9 統合要件
- 評価結果に基づく自動統合
- ロールバック機能
- 統合後の品質検証
- 継続的インテグレーション連携

### 11.10 エージェント通信プロトコル要件

#### 11.10.1 メッセージ通信システム
- **メッセージキュー**: Redis/RabbitMQ によるメッセージ配信
- **通信プロトコル**: WebSocket + JSON 形式のメッセージ交換
- **メッセージタイプ**: INSTRUCTION, QUESTION, EMERGENCY, SUGGESTION, STATUS, RESPONSE
- **配信保証**: 重要メッセージの配信確認・再送機能

#### 11.10.2 リモートアクセス基盤
- **Container Runtime**: Docker/Podman でのエージェント環境分離
- **ネットワーク**: 各エージェントコンテナへのHTTP/SSH ポートフォワーディング
- **認証**: JWT トークンベースの認証・認可
- **セッション管理**: Redis によるセッション状態管理

#### 11.10.3 IDE統合要件
- **Cursor Code Server**: Web版Cursor IDEの埋め込み
- **ファイル同期**: Git/rsync によるリアルタイムファイル同期
- **協調編集**: Operational Transform によるコンフリクト解決
- **プラグイン**: エージェント専用の開発支援プラグイン

#### 11.10.4 ターミナルアクセス
- **Terminal Emulator**: xterm.js による Web ターミナル
- **Shell Access**: bash/zsh シェルへのSSH接続
- **多重接続**: tmux/screen による複数セッション管理
- **コマンド制限**: 危険なコマンドの実行制限

#### 11.10.5 監視・ログ収集
- **アクセスログ**: 全てのリモートアクセス操作の記録
- **パフォーマンス監視**: CPU/メモリ/ネットワーク使用量の監視
- **セキュリティ監査**: 不正アクセス・権限昇格の検知
- **通信ログ**: メッセージ交換の完全な記録

## 12 将来の拡張

* 自動アンサンブルブレンディング
* 複数 GPU を用いた Optuna によるハイパーパラメータ探索
* Jina AI Embeddings と連携したテキスト系コンペの対応
* マルチエージェント開発システムの他プロジェクトへの適用

## 13 SLA・KPI定義

### 13.1 サービス品質指標（SLA）

| 項目           | 目標値      | 計測方法               |
| ------------ | -------- | ------------------ |
| **システム稼働率**  | 99.5%    | 月次稼働時間 / 総時間       |
| **エージェント応答** | ≤ 2秒     | メッセージ送信から応答までの時間   |
| **UI応答時間**   | ≤ 3秒     | ページ読み込み完了までの時間     |
| **データ復旧時間**  | ≤ 4時間    | 障害発生から完全復旧までの時間    |
| **エージェント成功率** | ≥ 80%    | 完了エージェント数 / 起動数    |

### 13.2 ビジネス成果指標（KPI）

| 項目               | 目標値         | 計測方法                    |
| ---------------- | ----------- | ----------------------- |
| **平均順位改善**       | Top 20%以内  | リーダーボード最終順位          |
| **初回提出時間**       | ≤ 24時間     | コンペ開始から初回提出までの時間      |
| **コスト効率**        | ≤ $50/コンペ | 1コンペあたりの総コスト           |
| **エージェント協調効率**   | ≥ 85%      | 人間介入後の成功改善率           |
| **リソース利用率**      | ≥ 75%      | GPU稼働時間 / 確保時間        |
| **自動化率**         | ≥ 90%      | 自動処理タスク数 / 総タスク数      |

### 13.3 運用品質指標

| 項目              | 目標値    | 計測方法               |
| --------------- | ------ | ------------------ |
| **平均故障間隔**      | ≥ 168時間 | 障害間の平均稼働時間         |
| **セキュリティインシデント** | 0件/月   | 月次セキュリティ事故発生件数     |
| **データ損失**       | 0件     | データ消失・破損事故件数       |
| **予算超過率**       | ≤ 5%   | (実際コスト-予算)/予算 × 100 |

## 14 コスト管理・予算制御

### 14.1 詳細コスト見積もり

**月次運用コスト（1コンペ/月想定）**

| カテゴリ          | 項目                | 単価         | 使用量      | 月額      |
| ------------- | ----------------- | ---------- | -------- | ------- |
| **GPU計算**     | RTX 4090 × 10エージェント | $0.32/時間   | 100時間    | $320    |
| **CPU計算**     | 管理サーバー            | $0.10/時間   | 720時間    | $72     |
| **ストレージ**     | データ・モデル保存        | $0.01/GB-月 | 500GB    | $5      |
| **API使用料**    | Claude Code       | $0.15/1Kトークン | 1Mトークン  | $150    |
| **API使用料**    | Deep Research     | $2.50/クエリ  | 50クエリ   | $125    |
| **ネットワーク**    | データ転送           | $0.01/GB   | 200GB    | $2      |
| **監視・ログ**     | Prometheus等      | $0.50/GB   | 20GB     | $10     |
| **セキュリティ**    | Vault、認証        | 固定費        | -        | $25     |
| **合計**        |                 |            |          | **$709** |

### 14.2 予算制御機能

**自動予算管理**
* リアルタイムコスト監視（1時間毎の使用量チェック）
* 予算の80%到達時の自動アラート
* 予算の95%到達時のエージェント自動停止
* 緊急時の手動予算追加承認フロー

**コスト最適化**
* GPU使用率に基づく自動スケールダウン
* 非使用時間帯（夜間）のリソース削減
* 成功率の低いエージェントの早期停止
* データ圧縮・重複排除によるストレージ最適化

## 15 データ管理・ガバナンス

### 15.1 データ分類・保存ポリシー

| データタイプ       | 保存期間 | 暗号化 | バックアップ | アクセス制御      |
| ------------ | ---- | --- | ------ | ----------- |
| **Kaggleデータ** | 永続   | AES-256 | 3重化    | 読み取り専用      |
| **学習済みモデル**  | 1年   | AES-256 | 2重化    | エージェント・管理者  |
| **実行ログ**     | 6ヶ月  | なし  | 1重化    | 管理者のみ       |
| **通信ログ**     | 3ヶ月  | AES-256 | 2重化    | セキュリティ監査者   |
| **ユーザーデータ**  | 永続   | AES-256 | 3重化    | 本人・管理者      |
| **API キー**    | 永続   | Vault | 3重化    | システムのみ      |

### 15.2 プライバシー・GDPR対応

**個人データ処理**
* ユーザー同意の明示的取得
* データ処理目的の明確化
* 個人データの最小限使用原則
* データポータビリティ権の保障

**データ削除・訂正権**
* ユーザー要求から30日以内の削除実行
* 完全削除の技術的実装（暗号鍵破棄）
* 削除ログの記録・監査証跡
* バックアップからの削除（90日以内）

## 16 コンプライアンス・法的要件

### 16.1 適用法規・規制

**データ保護規制**
* GDPR（EU一般データ保護規則）
* CCPA（カリフォルニア州消費者プライバシー法）
* 個人情報保護法（日本）

**AI・機械学習規制**
* EU AI Act への準拠
* アルゴリズムの透明性・説明可能性
* バイアス検出・軽減措置

### 16.2 利用規約・責任範囲

**サービス利用条件**
* Kaggle規約の遵守義務
* 禁止行為（データ漏洩、不正行為等）
* サービス中断・終了の条件
* 損害責任の限定

**知的財産権**
* 生成コード・モデルの著作権
* 第三者ライブラリのライセンス遵守
* 特許侵害リスクの回避

## 17 テスト戦略

### 17.1 テスト段階・種類

| テスト種類    | 実行頻度      | 自動化率 | 担当者      |
| -------- | --------- | ---- | -------- |
| **ユニットテスト** | コミット毎     | 100% | 開発者      |
| **統合テスト**  | PR毎       | 95%  | CI/CD    |
| **E2Eテスト**  | リリース前     | 80%  | QAチーム    |
| **性能テスト**  | 週次        | 90%  | 自動・手動   |
| **セキュリティテスト** | リリース前     | 70%  | セキュリティチーム |
| **カオステスト** | 月次        | 60%  | SREチーム   |

### 17.2 テスト環境戦略

**環境分離**
* **開発環境**: 個人開発・単体テスト
* **統合環境**: 機能統合・結合テスト  
* **ステージング環境**: 本番同等・受入テスト
* **本番環境**: 実運用・監視

**テストデータ**
* 過去のKaggleコンペデータの活用
* 個人情報の完全マスキング
* 多様なデータサイズ・形式での検証
* 異常データ・エッジケースの網羅

## 18 展開・移行戦略

### 18.1 段階的ロールアウト

**フェーズ1: プロトタイプ検証（4週間）**
* 1エージェント・簡単なTabularコンペでの動作確認
* 基本UIの動作検証
* コア機能の安定性確認

**フェーズ2: ベータ版展開（8週間）**
* 3エージェント並列実行
* 限定ユーザー（5名）でのテスト
* フィードバック収集・改善実装

**フェーズ3: 本格運用（12週間）**
* 10エージェント並列実行
* 全機能の提供開始
* 24時間サポート体制の開始

### 18.2 リスク軽減策

**カナリアデプロイ**
* 新機能の段階的展開（5% → 25% → 50% → 100%）
* 自動ロールバック機能
* A/Bテストによる効果測定

**フェイルセーフ機能**
* 旧バージョンへの即座切り戻し
* 手動モードでの緊急運用継続
* 重要データの事前バックアップ

## 19 運用・サポート要件

### 19.1 運用体制

**役割分担**
* **システム管理者**: インフラ監視・保守
* **エージェント管理者**: AI エージェントの動作監視
* **セキュリティ管理者**: セキュリティ監視・インシデント対応
* **ユーザーサポート**: 問い合わせ対応・トレーニング

**勤務体制**
* 平日9-18時: フルサポート体制（4名）
* 夜間・休日: オンコール体制（1名）
* 緊急時: 30分以内の初動対応

### 19.2 監視・アラート

**監視項目**
* システム稼働状況（CPU、メモリ、ディスク）
* エージェント実行状況・エラー率
* API応答時間・エラー率
* セキュリティイベント・異常アクセス
* コスト使用量・予算超過リスク

**アラート基準**
* Critical: サービス停止・データ損失リスク → 即座対応
* Warning: 性能劣化・予算超過予兆 → 1時間以内対応
* Info: 通常範囲内の変動 → 翌営業日対応

### 19.3 バックアップ・災害復旧

**バックアップ戦略**
* **フルバックアップ**: 週次（日曜深夜）
* **増分バックアップ**: 日次（毎日深夜）
* **リアルタイム複製**: 重要データ（API キー、設定）
* **地理的分散**: 3つの異なるリージョンに保存

**災害復旧手順**
* **RTO（復旧時間目標）**: 4時間以内
* **RPO（復旧点目標）**: 1時間以内
* **自動フェイルオーバー**: 30秒以内
* **復旧訓練**: 月次実施

---

*以上が日本語版要件定義（バージョン 1.0）です。ご確認ください。* 